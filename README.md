## Quantifying Price Improvement in Order Flow Auctions

Bachu, B., Wan, X. and Moallemi, C.C. (2024) 'Quantifying Price Improvement in Order Flow Auctions', arXiv preprint arXiv:2405.00537.


### Challenges for AMMs

The document identifies several challenges faced by Automated Market Makers (AMMs) on blockchain systems like Ethereum:

1. **Fragmented Liquidity**: AMMs encounter issues with fragmented liquidity.
2. **Susceptibility to Adversarial Strategies**: AMMs are susceptible to adversarial strategies that can extract value from the system.
3. **Unpredictable Trade Executions**: AMM trade executions can be unpredictable.

These challenges have led to significant financial losses in the ecosystem, with studies estimating that inefficiencies and adversarial strategies have extracted over $540 million USD from the AMM ecosystem over 32 months.

### Framework for Price Improvement in OFAs

The paper proposes a framework to define and evaluate price improvements in onchain Order Flow Auctions (OFAs). This includes:

1. **Price Definition**: A definition of "price" that internalizes the gas cost of the transaction, making it applicable across different OFA implementations.
2. **Price Improvement Definition**: Price improvement ($\pi$) is defined as the relative difference between the realized price ($p$) and a baseline/counterfactual price ($p'$).
3. **Counterfactual Price Generation**: The baseline/counterfactual price ($p'$) is generated by simulating the trade using the Uniswap routing API and the Tenderly simulator, to mimic what a typical user could achieve outside of the OFA.
4. **Attribution Model**: The paper proposes a model to attribute the price improvement to various controllable inputs like routing efficiency, gas optimization, and priority fee settings.

### Empirical Findings

The methodology was applied to historical data from OFA interfaces like 1Inch and Uniswap, revealing that:

1. **Price Improvement Findings**: OFAs, particularly those utilizing RFQ-informed onchain Dutch auction systems (like 1Inch Fusion and UniswapX), provide statistically significant price improvements for users, averaging 4-5 basis points. The price improvements are more pronounced for larger trade sizes, while smaller trades exhibit more variability.
2. **Attribution Findings**: The majority of price improvements on both 1Inch and Uniswap interfaces are achieved through better routing and access to additional liquidity sources. OFAs like 1Inch Fusion and UniswapX show a small but non-zero amount of gas overhead compared to traditional AMMs like Uniswap Classic, translating to 0.5-1 basis points of degradation. The interaction between gas efficiency and priority fee savings also contributes a decent amount to the overall price improvements.
3. **Comparison Findings**: At the interface level, the Uniswap interface provides significantly higher price improvements than the 1Inch interface, except for a few blocks prior to settlement. Both interfaces demonstrate statistically significant positive price improvements compared to the common baseline across a range of block offsets.

### Execution Quality in OFAs

In the context of OFA systems, execution quality refers to the overall effectiveness and desirability of the trade execution experienced by users. The paper focuses on evaluating execution quality through the lens of "price improvement", which is defined as the difference between the realized price of a swap and a counterfactual baseline price.

Specifically, the paper highlights a few key aspects of execution quality in OFA systems:

1. **Price Improvement**: This is the primary metric used to assess execution quality. It captures how much better (or worse) the realized price is compared to a simulated baseline trade.
2. **Factors Affecting Price Improvement**: Routing Efficiency, Gas Optimization, and Priority Fee Settings.
3. **Comparison Across OFA Systems**: The framework allows for a systematic comparison of execution quality across different OFA implementations, such as 1Inch Fusion, UniswapX, 1Inch Aggregator, and Uniswap Classic.
4. **Timing Considerations**: The paper also evaluates price improvement at different time offsets from the settlement block, to account for factors like transaction ordering and blockchain state changes.

### Mathematical Formulations

The key mathematical formulations presented in the paper are:

1. **Price Definition**:
   - For transactions where the input or output token is the gas token (e.g., ETH/WETH):
     $p = o / (i + g(b + f))$

   - For transactions where gas is internalized by the OFA:
     $p = o / i$

2. **Price Improvement (PI)**:
   - $\pi = (p - p') / p'$
   - Where $p$ is the realized price and $p'$ is the counterfactual baseline price

3. **Price Improvement Attribution**:
   - $\pi = \pi_{routing} + \pi_{gas} + \pi_{fee}$
   - Where:
     - $\pi_{routing}$ represents PI from routing optimization
     - $\pi_{gas}$ represents PI from gas optimization
     - $\pi_{fee}$ represents PI from priority fee optimization

4. **PI Attribution Model**:
   - Using a Taylor series expansion:
     $\pi = (\partial p / \partial o) |_{o',g',f'} * (o - o') / p' + (\partial p / \partial g) |_{o',g',f'} * (g - g') / p' + (\partial p / \partial f) |_{o',g',f'} * (f - f') / p' + R(x, x')$
     - Where $R(x, x')$ is the remainder term

5. **Price Improvement over Time**:
   - $\rho(p; p', \Delta t) = (p - p'(\Delta t)) / p'(\Delta t)$
   - Where $\Delta t$ is the time offset from the settlement time

6. **Baseline Generation**:
   - $B: (i, t) \rightarrow (o', g')$
   - Where $B$ is the baseline function that maps input amount $i$ and time $t$ to the counterfactual output amount $o'$ and gas used $g'$

These mathematical formulations provide the foundation for the framework described in the paper to evaluate and compare the price improvement performance of different OFA systems.
